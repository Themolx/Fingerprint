<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUBJECT DOSSIER</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Display';
      src: local('Neue Montreal Bold'), local('NeueMontreal-Bold');
      font-weight: bold;
      font-style: normal;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --font: 'Display', 'Inter', -apple-system, 'Helvetica Neue', Arial, sans-serif;
    }

    html, body {
      width: 100%; height: 100%;
      background: #000;
      color: #fff;
      font-family: var(--font);
      overflow: hidden;
      cursor: default;
      -webkit-font-smoothing: antialiased;
    }

    #stage {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 60px 80px;
    }

    .line {
      font-weight: 400;
      line-height: 1.25;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .line.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .line.bold {
      font-weight: 700;
    }

    .line.spacer {
      height: 0.5em;
    }

    #stage.fade-out .line {
      opacity: 0 !important;
      transform: translateY(-4px) !important;
      transition: opacity 0.25s ease-in, transform 0.25s ease-in;
    }

    #cursor {
      display: inline-block;
      width: 3px;
      background: #fff;
      margin-left: 8px;
      vertical-align: baseline;
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 0; }
    }

    #hint {
      position: fixed;
      bottom: 30px;
      left: 80px;
      font-size: 12px;
      color: #333;
      font-weight: 400;
      font-family: var(--font);
      transition: opacity 0.5s;
    }

    #footer {
      display: none;
      position: fixed;
      bottom: 30px;
      left: 80px;
      right: 80px;
      font-size: 11px;
      color: #222;
      font-weight: 400;
      font-family: var(--font);
      letter-spacing: 0.5px;
    }
    #footer a { color: #333; text-decoration: none; }
    #footer a:hover { color: #fff; }
    #footer .repos { display: flex; flex-wrap: wrap; gap: 6px 16px; margin-top: 6px; }

    @media (max-width: 768px) {
      #stage { padding: 40px 30px; }
      #hint { left: 30px; bottom: 20px; }
      #footer { left: 30px; right: 30px; }
    }
  </style>
</head>
<body>
  <div id="stage"></div>
  <div id="hint">press space to skip</div>
  <div id="footer">
    <div>Themolx</div>
    <div class="repos" id="repos"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
  <script src="shared/inference-engine.js"></script>
  <script src="web/js/entropy.js"></script>
  <script src="web/js/pricing.js"></script>

  <script>
  (async () => {
    const stage = document.getElementById('stage');
    const hint = document.getElementById('hint');
    let skipRequested = false;
    let currentResolve = null;

    document.addEventListener('keydown', e => {
      if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
        skipRequested = true;
        if (currentResolve) currentResolve();
      }
    });
    document.addEventListener('click', () => {
      skipRequested = true;
      if (currentResolve) currentResolve();
    });

    function wait(ms) {
      if (skipRequested) { skipRequested = false; return Promise.resolve(); }
      return new Promise(resolve => {
        currentResolve = resolve;
        setTimeout(() => { currentResolve = null; resolve(); }, ms);
      });
    }

    // ---- Fit font size to viewport (weight-aware) ----
    function fitSize(text, maxW, maxPx, minPx, weight) {
      const el = document.createElement('span');
      el.style.cssText = `position:absolute;visibility:hidden;white-space:nowrap;font-family:var(--font);font-weight:${weight === 'bold' ? 700 : 400};`;
      document.body.appendChild(el);
      for (let s = maxPx; s >= minPx; s -= 2) {
        el.style.fontSize = s + 'px';
        el.textContent = text;
        if (el.offsetWidth <= maxW) { document.body.removeChild(el); return s; }
      }
      document.body.removeChild(el);
      return minPx;
    }

    // ---- Web Audio sonification ----
    let audioCtx = null;
    function initAudio() {
      if (audioCtx) return;
      try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
    }
    function playClick() {
      if (!audioCtx) return;
      try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(200 + Math.random() * 400, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.12);
      } catch(e) {}
    }
    let droneOsc = null, droneGain = null;
    function startDrone() {
      if (!audioCtx) return;
      try {
        droneOsc = audioCtx.createOscillator();
        droneGain = audioCtx.createGain();
        droneOsc.type = 'sine';
        droneOsc.frequency.value = 45;
        droneGain.gain.value = 0;
        droneGain.gain.linearRampToValueAtTime(0.04, audioCtx.currentTime + 3);
        droneOsc.connect(droneGain);
        droneGain.connect(audioCtx.destination);
        droneOsc.start();
      } catch(e) {}
    }
    function stopDrone() {
      if (droneGain && audioCtx) {
        try {
          droneGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2);
          setTimeout(() => { try { droneOsc.stop(); } catch(e) {} }, 3000);
        } catch(e) {}
      }
    }

    // ---- Show a block of lines ----
    async function showBlock(lines, holdMs) {
      stage.classList.remove('fade-out');
      stage.innerHTML = '';

      const maxW = window.innerWidth - 160;
      const isMobile = window.innerWidth < 768;
      const maxFont = isMobile ? 60 : 120;
      const minFont = isMobile ? 24 : 32;

      const els = [];
      for (const text of lines) {
        const div = document.createElement('div');
        div.classList.add('line');
        if (text === '') {
          div.classList.add('spacer');
        } else {
          const isBold = text.startsWith('!');
          const cleanText = isBold ? text.slice(1) : text;
          const weight = isBold ? 'bold' : 'normal';
          if (isBold) div.classList.add('bold');
          const sz = fitSize(cleanText, maxW, maxFont, minFont, weight);
          div.style.fontSize = sz + 'px';
          div.textContent = cleanText;
        }
        stage.appendChild(div);
        els.push(div);
      }

      // Sonification click on each block
      playClick();

      // Stagger line appearance
      for (let i = 0; i < els.length; i++) {
        await wait(skipRequested ? 30 : 180);
        els[i].classList.add('visible');
      }

      // Add cursor after last visible text line
      const lastText = els.filter(e => !e.classList.contains('spacer')).pop();
      if (lastText) {
        const cursor = document.createElement('span');
        cursor.id = 'cursor';
        cursor.style.height = (parseInt(lastText.style.fontSize) * 0.8) + 'px';
        lastText.appendChild(cursor);
      }

      // Hold
      await wait(skipRequested ? 200 : holdMs);

      // Fade out
      stage.classList.add('fade-out');
      await wait(skipRequested ? 100 : 300);
    }

    // ---- Collect fingerprint data ----
    async function collectData() {
      const basic = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        languages: Array.from(navigator.languages || []),
        cookieEnabled: navigator.cookieEnabled,
        hardwareConcurrency: navigator.hardwareConcurrency,
        deviceMemory: navigator.deviceMemory,
        screenWidth: screen.width,
        screenHeight: screen.height,
        screenAvailWidth: screen.availWidth,
        screenAvailHeight: screen.availHeight,
        colorDepth: screen.colorDepth,
        pixelDepth: screen.pixelDepth,
        devicePixelRatio: window.devicePixelRatio,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        timezoneOffset: new Date().getTimezoneOffset(),
        maxTouchPoints: navigator.maxTouchPoints || 0,
        pdfViewerEnabled: navigator.pdfViewerEnabled,
        webdriver: navigator.webdriver || false,
      };

      // Connection
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (conn) {
        basic.connectionType = conn.effectiveType;
        basic.connectionDownlink = conn.downlink;
        basic.connectionRtt = conn.rtt;
        basic.connectionSaveData = conn.saveData;
      }

      // DNT
      basic.doNotTrack = navigator.doNotTrack;

      // Battery
      let battery = null;
      try {
        const b = await navigator.getBattery();
        battery = {
          charging: b.charging,
          level: b.level,
          chargingTime: b.chargingTime,
          dischargingTime: b.dischargingTime,
        };
      } catch(e) {}

      // Media devices
      let mediaDevices = { audioinput: 0, audiooutput: 0, videoinput: 0 };
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        for (const d of devices) {
          if (mediaDevices[d.kind] !== undefined) mediaDevices[d.kind]++;
        }
      } catch(e) {}

      // WebGL
      let webgl = {};
      try {
        const c = document.createElement('canvas');
        const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
        if (gl) {
          const dbg = gl.getExtension('WEBGL_debug_renderer_info');
          webgl.vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
          webgl.renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
          webgl.version = gl.getParameter(gl.VERSION);
        }
      } catch(e) {}

      // FingerprintJS
      let advanced = {};
      try {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        advanced.visitorId = result.visitorId;
        advanced.confidence = result.confidence?.score;
        advanced.components = result.components;
      } catch(e) {}

      // Fonts from FingerprintJS
      let fonts = [];
      if (advanced.components?.fonts?.value) {
        fonts = advanced.components.fonts.value;
      }

      // Canvas hash
      let canvas = null;
      try {
        const c = document.createElement('canvas');
        c.width = 200; c.height = 50;
        const ctx = c.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('fingerprint', 2, 2);
        canvas = c.toDataURL().slice(0, 100);
      } catch(e) {}

      // Audio fingerprint
      let audio = null;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const analyser = ctx.createAnalyser();
        const gain = ctx.createGain();
        const processor = ctx.createScriptProcessor(4096, 1, 1);
        gain.gain.value = 0;
        osc.type = 'triangle';
        osc.connect(analyser);
        analyser.connect(processor);
        processor.connect(gain);
        gain.connect(ctx.destination);
        osc.start(0);
        const data = new Float32Array(analyser.fftSize);
        analyser.getFloatFrequencyData(data);
        audio = data.slice(0, 10).reduce((a, b) => a + Math.abs(b), 0).toFixed(4);
        osc.stop();
        ctx.close();
      } catch(e) {}

      return {
        basic,
        advanced,
        webgl,
        canvas,
        audio,
        fonts,
        battery,
        mediaDevices,
        collectedAt: new Date().toISOString(),
      };
    }

    // ---- V3-style smooth timing (ms) ----
    function smoothTiming(lineCount, importance) {
      const base = 700 + Math.max(0, lineCount - 1) * 250;
      if (importance === 'flash') return Math.max(500, base * 0.6);
      if (importance === 'linger') return base * 1.6;
      return base;
    }

    // ---- Build data-conditional monolog (v4) ----
    function buildMonolog(fpData, profile, entropy, uniqueness, pricing) {
      const d = fpData.basic || {};
      const gpu = fpData.webgl?.renderer || '';
      const fonts = fpData.fonts || [];
      const battery = fpData.battery || {};
      const media = fpData.mediaDevices || {};

      const dev = profile.device;
      const loc = profile.location;
      const inc = profile.income;
      const tech = profile.techLiteracy;
      const prof = profile.profession;

      const chipMatch = gpu.match(/Apple (M\d+\s*\w*)/i);
      const chip = chipMatch ? chipMatch[1] : '';
      const nvidiaMatch = gpu.match(/((?:RTX|GTX)\s*\d+\s*\w*)/i);
      const nvidia = nvidiaMatch ? nvidiaMatch[1] : '';
      const amdMatch = gpu.match(/(Radeon\s*(?:RX)?\s*\d+\s*\w*)/i);
      const amd = amdMatch ? amdMatch[1] : '';

      const isMobile = dev.parsed.mobile === true;
      const isApple = dev.parsed.os === 'macOS' || dev.parsed.os === 'iOS';
      const isLinux = dev.parsed.os === 'Linux';
      const isWindows = dev.parsed.os === 'Windows';
      const isPremium = dev.deviceTier === 'Premium';
      const hasHighMemory = (d.deviceMemory || 0) >= 8;
      const hasHighCores = (d.hardwareConcurrency || 0) >= 8;
      const hasRetina = (d.devicePixelRatio || 1) >= 2;
      const hasWideColor = d.colorDepth >= 30;
      const hasWebcam = (media.videoinput || 0) > 0;
      const hasMic = (media.audioinput || 0) > 0;
      const hasDNT = d.doNotTrack === '1' || d.doNotTrack === 1;
      const hasCookies = d.cookieEnabled !== false;
      const isFirefox = dev.parsed.browser === 'Firefox';
      const isSafari = dev.parsed.browser === 'Safari';
      const isBrave = (d.userAgent || '').includes('Brave');
      const isChrome = dev.parsed.browser === 'Chrome' && !isBrave;

      const raw = [];
      function add(lines, importance) {
        raw.push({ lines: lines.filter(Boolean), importance: importance || 'normal' });
      }

      // 1. OPENING
      add(['!scanning.'], 'normal');

      // 2. DEVICE
      if (isApple && chip) {
        add([dev.parsed.os.toLowerCase() + ' ' + dev.parsed.osVersion + '.', chip.toLowerCase() + '.', 'apple silicon.'], 'normal');
        add(['!premium hardware.'], 'flash');
      } else if (isApple && !chip) {
        add([dev.parsed.os.toLowerCase() + ' ' + dev.parsed.osVersion + '.', 'apple. intel era.'], 'normal');
        add(['!aging hardware. still premium brand.'], 'flash');
      } else if (isWindows && nvidia) {
        add(['windows ' + dev.parsed.osVersion + '.', nvidia.toLowerCase() + '.'], 'normal');
        if (nvidia.match(/RTX\s*(30|40|50)/i)) add(['!gaming rig. or workstation.', '!either way: disposable income.'], 'normal');
        else add(['mid-range GPU.', '!practical.'], 'flash');
      } else if (isWindows && amd) {
        add(['windows ' + dev.parsed.osVersion + '.', amd.toLowerCase() + '.'], 'normal');
        add(['!AMD build. value-oriented.'], 'flash');
      } else if (isWindows) {
        add(['windows ' + dev.parsed.osVersion + '.'], 'normal');
        if (hasHighMemory && hasHighCores) add(['!powerful machine. workstation class.'], 'normal');
        else add([(d.deviceMemory||'?') + 'GB RAM.', '!consumer tier.'], 'flash');
      } else if (isLinux) {
        add(['linux.'], 'normal');
        add(['!technical subject.', '!privacy-conscious? or just stubborn.'], 'normal');
      } else if (dev.parsed.os === 'iOS') {
        add(['iOS ' + dev.parsed.osVersion + '.', 'apple ecosystem.'], 'normal');
        add(['!high-value mobile target.'], 'flash');
      } else if (dev.parsed.os === 'Android') {
        if (hasHighMemory) add(['android. ' + (d.deviceMemory||'?') + 'GB. flagship.'], 'normal');
        else add(['android. ' + (d.deviceMemory||'?') + 'GB.', 'budget device. emerging market?'], 'normal');
      } else {
        add([dev.parsed.os.toLowerCase() + ' ' + dev.parsed.osVersion + '.'], 'normal');
      }

      // 3. FORM FACTOR
      if (!isMobile && hasWebcam && hasMic && (d.maxTouchPoints||0) === 0) {
        if (isApple) add(['webcam. microphone. no touch.', '!=laptop. probably macbook.'], 'normal');
        else add(['webcam. microphone. no touch.', '!=laptop.'], 'normal');
      } else if (!isMobile && !hasWebcam && hasMic) {
        add(['no webcam. external mic.', '!desktop workstation.'], 'normal');
      } else if (isMobile && (d.maxTouchPoints||0) > 3) {
        add(['multi-touch. ' + d.maxTouchPoints + ' points.', 'mobile device.'], 'normal');
      }

      // 4. TECH LITERACY (data-driven)
      const techScore = tech.score || 50;
      if (techScore >= 80) {
        add(['tech literacy: ' + techScore + '/100.', '!expert level.'], 'normal');
        add(['!knows shortcuts. skips tutorials.', '!reads documentation. for fun.'], 'normal');
        add(['!harder to monetize. resistant to clickbait.'], 'flash');
      } else if (techScore >= 60) {
        add(['tech literacy: ' + techScore + '/100.', '!above average.'], 'normal');
        add(['!will research before purchasing.', 'serve comparison ads. reviews.'], 'normal');
      } else if (techScore >= 40) {
        add(['tech literacy: ' + techScore + '/100.', '!average user.'], 'normal');
        add(['!standard targeting effective.'], 'flash');
      } else {
        add(['tech literacy: ' + techScore + '/100.', '!below average.'], 'normal');
        add(['!susceptible to urgency tactics.', '!"limited time offer" works here.'], 'normal');
      }

      // 5. BROWSER + TRACKING
      if (isBrave) {
        add(['brave browser.', 'privacy-focused. actively hiding.'], 'normal');
        add(['!still visible. still trackable.', '!the fingerprint doesn\'t lie.'], 'linger');
      } else if (isFirefox) {
        add(['firefox.', hasDNT ? 'do-not-track: enabled.' : 'no do-not-track.'], 'normal');
        if (hasDNT) add(['!irony: DNT makes the fingerprint more unique.', '!trying to hide. standing out instead.'], 'normal');
      } else if (isSafari) {
        add(['safari.', 'some built-in protections.'], 'normal');
        add(['!apple\'s privacy theater.', '!enough to feel safe. not enough to be safe.'], 'normal');
      } else if (isChrome) {
        add(['chrome ' + dev.parsed.browserVersion + '.', hasCookies ? 'cookies: enabled.' : 'cookies: blocked.', hasDNT ? 'do-not-track: on.' : 'no do-not-track.'], 'normal');
        if (!hasDNT && hasCookies) {
          add(['!default settings. no resistance.'], 'flash');
          add(['!thinks incognito means invisible.'], 'flash');
        }
      } else {
        add([dev.parsed.browser.toLowerCase() + ' ' + dev.parsed.browserVersion + '.'], 'normal');
      }

      // 6. HARDWARE
      const hwParts = [];
      if (d.hardwareConcurrency) hwParts.push(d.hardwareConcurrency + ' cores.');
      if (d.deviceMemory) hwParts.push(d.deviceMemory + 'GB RAM.');
      if (hwParts.length > 0) add([hwParts.join(' ')], 'normal');

      if (d.screenWidth && d.screenHeight) add([d.screenWidth + '\u00d7' + d.screenHeight + ' @' + (d.devicePixelRatio||1) + 'x.'], 'normal');

      if (hasWideColor && hasRetina) {
        add([d.colorDepth + '-bit color. wide gamut. HDR.', '!professional-grade display.'], 'normal');
        add(['!content creator? photographer? designer?'], 'flash');
      } else if (hasRetina) {
        add(['retina display.' + (isPremium ? ' premium screen.' : '')], 'flash');
      }

      // 7. BATTERY
      if (battery && battery.level !== undefined) {
        const pct = Math.round(battery.level * 100);
        if (battery.charging) {
          add(['battery: ' + pct + '%. charging.', 'plugged in. stationary.'], 'normal');
          add(['!settled in. not going anywhere.'], 'flash');
        } else if (pct <= 20) {
          add(['battery: ' + pct + '%. not charging.', 'running low. will leave soon.'], 'normal');
          add(['!limited window. act fast.'], 'flash');
        } else if (pct <= 50) {
          add(['battery: ' + pct + '%. on battery.', 'mobile. or forgot the charger.'], 'normal');
        } else {
          add(['battery: ' + pct + '%.', 'session could be long.'], 'normal');
        }
      }

      // 8. TIME OF DAY
      let localHour = null;
      const now = new Date();
      if (d.timezoneOffset !== undefined) {
        const local = new Date(now.getTime() - d.timezoneOffset * 60000);
        localHour = local.getUTCHours();
      }
      if (localHour !== null) {
        const h = localHour, m = now.getMinutes();
        const ts = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
        if (h >= 0 && h < 5) {
          add([ts + ' local time.', 'deep night.'], 'normal');
          add(['!impulse control lowest between midnight and 4am.', '!increase bid.'], 'linger');
        } else if (h >= 22 || h === 5) {
          add([ts + ' local time.', 'late night.'], 'normal');
          add(['!can\'t sleep? or won\'t sleep?', 'late night purchases convert 40% better.'], 'linger');
        } else if (h >= 6 && h < 9) {
          add([ts + ' local time.', 'early session.'], 'normal');
          add(['!routine browser. habitual.', 'serve morning news. coffee ads.'], 'normal');
        } else if (h >= 9 && h < 12) {
          add([ts + ' local time.', 'morning. work hours.'], 'normal');
          add(['!should be working. procrastinating.', '!receptive to distractions.'], 'normal');
        } else if (h >= 12 && h < 14) {
          add([ts + ' local time.', 'lunch break.'], 'normal');
          add(['browsing. shopping.', '!food delivery? retail?'], 'normal');
        } else if (h >= 14 && h < 17) {
          add([ts + ' local time.', 'afternoon slump.'], 'normal');
          add(['!attention fading. easier to convert.'], 'flash');
        } else if (h >= 17 && h < 20) {
          add([ts + ' local time.', 'evening.'], 'normal');
          add(['!decision fatigue setting in.', '!emotional purchases peak now.'], 'normal');
        } else {
          add([ts + ' local time.', 'late evening.'], 'normal');
          add(['!winding down. guard lowered.'], 'flash');
        }
      }

      // 9. LOCATION
      add([(d.timezone || 'unknown timezone').toLowerCase() + '.', loc.country.toLowerCase() + '.', loc.market.toLowerCase() + ' market.'], 'normal');

      const langCode = (d.language || '').substring(0, 2).toLowerCase();
      const langInForeign = langCode === 'en' && !['United States','United Kingdom','Canada','Australia','Ireland','New Zealand'].includes(loc.country);
      const nonEnglishInEnglish = langCode !== 'en' && ['United States','United Kingdom','Canada','Australia'].includes(loc.country);
      if (langInForeign) {
        add(['english speaker in ' + loc.country.toLowerCase() + '.', 'expatriate? remote worker? digital nomad?'], 'normal');
        add(['!probably misses home.', '!show airline ads. relocation services.'], 'normal');
      } else if (nonEnglishInEnglish) {
        add([d.language.toLowerCase() + ' speaker in ' + loc.country.toLowerCase() + '.', 'immigrant? international student?'], 'normal');
        add(['!target with community services.', '!language learning ads.'], 'normal');
      }

      // 10. FONT FORENSICS
      const designFonts = fonts.filter(f => ['Futura','Avenir','Avenir Next','Gill Sans','Helvetica Neue','Open Sans','Proxima Nova'].includes(f));
      const devFonts = fonts.filter(f => ['Menlo','Monaco','Consolas','Fira Code','Source Code Pro','SF Mono'].includes(f));
      if (devFonts.length > 0 && designFonts.length > 0) {
        add(['developer fonts: ' + devFonts.slice(0,2).join(', ').toLowerCase() + '.', 'design fonts: ' + designFonts.slice(0,2).join(', ').toLowerCase() + '.'], 'normal');
        add(['!builds things AND makes them pretty.', '!rare combination. high value.'], 'normal');
      } else if (devFonts.length > 0) {
        add(['developer fonts detected.', devFonts.slice(0,3).join(', ').toLowerCase() + '.'], 'normal');
        add(['!writes code.'], 'flash');
      } else if (designFonts.length > 0) {
        add(['design fonts detected.', designFonts.slice(0,3).join(', ').toLowerCase() + '.'], 'normal');
        add(['!visual professional.'], 'flash');
      } else if (fonts.length > 20) {
        add([fonts.length + ' fonts installed.', 'above average. creative field?'], 'normal');
      }

      // 11. PROFESSION
      const allProf = prof.all || [];
      if (allProf.length > 0) {
        add(allProf.slice(0, 3).map(p => p.label.toLowerCase() + '. (' + Math.round(p.confidence * 100) + '%)'), 'normal');
      }

      // 12. INCOME
      if (inc.bracket === 'High' || inc.bracket === 'Upper-Middle') {
        add([inc.bracket.toLowerCase() + ' income.', 'est. ' + inc.estimate.toLowerCase() + '.'], 'normal');
        add(['!premium ad inventory.', 'luxury brands. SaaS. investment products.'], 'normal');
        add(['!could afford to say no.', '', '!doesn\'t.'], 'linger');
      } else if (inc.bracket === 'Middle') {
        add(['middle income.', 'est. ' + inc.estimate.toLowerCase() + '.'], 'normal');
        add(['!volume target.', 'discount codes. subscription trials.'], 'normal');
      } else {
        add(['lower income bracket.', 'est. ' + inc.estimate.toLowerCase() + '.'], 'normal');
        add(['!cost-sensitive.', 'payday loan ads. buy-now-pay-later.'], 'normal');
      }

      // 13. CONNECTION
      if (d.connectionType === '4g' && (d.connectionDownlink||0) > 5) {
        add(['fast connection. ' + d.connectionDownlink + ' mbps.', 'serve rich media. video ads.'], 'normal');
      } else if (d.connectionType === '3g' || d.connectionType === '2g') {
        add(['slow connection. ' + d.connectionType + '.', 'text-only ads. lightweight creatives.'], 'normal');
      }

      // 14. ENTROPY
      const bits = entropy.totalBits;
      if (bits > 50) {
        add([bits.toFixed(1) + ' bits of entropy.', 'extremely unique.'], 'normal');
        add(['identifiable among ' + uniqueness.populationSize + '.', uniqueness.percent + '%.'], 'normal');
      } else if (bits > 30) {
        add([bits.toFixed(1) + ' bits of entropy.', 'highly unique.'], 'normal');
        add([uniqueness.percent + '% identifiable.'], 'flash');
      } else if (bits > 15) {
        add([bits.toFixed(1) + ' bits.', 'moderately unique.', 'combined with other signals: identifiable.'], 'normal');
      } else {
        add([bits.toFixed(1) + ' bits.', 'common profile. harder to single out.', 'but not impossible.'], 'normal');
      }

      add(['canvas: unique.', 'audio: unique.', 'GPU: unique.', '!every signal confirms: one subject.'], 'normal');
      add(['needle in a haystack?', '', '!subject IS the needle.'], 'linger');

      // 15. VALUATION
      add(['$' + pricing.cpm.toFixed(2) + ' CPM.', '$' + pricing.annualValue.toFixed(0) + '/year.'], 'normal');
      add(['!less than a coffee.', '!but thousands of times a day.'], 'normal');

      const factors = pricing.factors || [];
      if (factors.length > 0) add(factors.slice(0, 4).map(f => f.label.toLowerCase() + ': ' + f.effect.toLowerCase() + '.'), 'normal');

      // 16. IDENTIFICATION
      add(['!subject fully profiled.'], 'flash');
      add(['!we gave you a name.', '!you didn\'t choose it.'], 'normal');
      const vid = fpData.advanced?.visitorId || 'unknown';
      add(['visitor ID:', vid], 'normal');
      add(['collected in seconds.', 'no permission required.'], 'normal');

      // 17. ENDING — switches to "you"
      add(['classification:', '!advertising commodity.'], 'linger');
      add(['!filed. indexed. sold.', '!again and again and again.'], 'linger');
      add(['you can close this tab.', '', '!we already have what we need.'], 'linger');
      add(['!you are the product.'], 'linger');

      // Apply smooth timing (v3-style)
      for (let i = 0; i < raw.length; i++) {
        raw[i].hold = smoothTiming(raw[i].lines.length, raw[i].importance);
      }

      return raw;
    }

    // ---- Load GitHub repos ----
    async function loadRepos() {
      try {
        const resp = await fetch('https://api.github.com/users/Themolx/repos?sort=updated&per_page=20');
        const repos = await resp.json();
        const container = document.getElementById('repos');
        repos.filter(r => !r.fork && r.name !== '.github').slice(0, 12).forEach(r => {
          const a = document.createElement('a');
          a.href = r.html_url;
          a.target = '_blank';
          a.textContent = r.name.toLowerCase();
          container.appendChild(a);
        });
      } catch(e) {}
    }

    // ---- Run ----

    // Show scanning immediately
    // Init audio on first interaction or immediately
    initAudio();
    document.addEventListener('click', initAudio, { once: true });
    document.addEventListener('keydown', initAudio, { once: true });
    startDrone();

    await showBlock(['!scanning.'], 600);

    // Collect data + load repos in parallel
    const [fpData] = await Promise.all([collectData(), loadRepos()]);

    // Process
    const profile = InferenceEngine.generateFullProfile(fpData);
    const entropy = EntropyEngine.calculateEntropy(fpData);
    const uniqueness = EntropyEngine.calculateUniqueness(entropy.totalBits);
    const pricing = PricingEngine.getBreakdown(profile);

    // Build monolog (skip first "scanning." — already shown)
    const blocks = buildMonolog(fpData, profile, entropy, uniqueness, pricing);

    // Play through blocks (skip first scanning block)
    for (let i = 1; i < blocks.length; i++) {
      await showBlock(blocks[i].lines, blocks[i].hold);
    }

    // Keep final message visible
    stage.classList.remove('fade-out');
    stage.innerHTML = '';
    const finalDiv = document.createElement('div');
    finalDiv.classList.add('line', 'bold');
    const sz = fitSize('you are the product.', window.innerWidth - 160, window.innerWidth < 768 ? 60 : 120, 32, 'bold');
    finalDiv.style.fontSize = sz + 'px';
    finalDiv.textContent = 'you are the product.';
    stage.appendChild(finalDiv);
    requestAnimationFrame(() => finalDiv.classList.add('visible'));
    hint.style.opacity = '0';
    stopDrone();

    // Show footer with repos
    document.getElementById('footer').style.display = 'block';

  })();
  </script>
</body>
</html>
